# ================================================================================================
# Azure DevOps Pipeline for CTS VibeApp Enhanced
# ================================================================================================
# This pipeline will:
# 1. Build your Node.js application
# 2. Run tests (if available)
# 3. Deploy to Azure App Service
# 4. Provide production-ready deployment
# ================================================================================================

trigger:
- main
- develop

variables:
  # Azure Service connection name (configure in Azure DevOps)
  azureSubscription: 'Azure-Service-Connection'
  
  # Web app name - UPDATE THIS with your actual App Service name
  webAppName: 'cts-vibeapp-enhanced'
  
  # Environment name
  environmentName: 'CTS-VibeApp-Production'
  
  # Node.js version
  nodeVersion: '18.x'
  
  # Build configuration
  buildConfiguration: 'production'

stages:
# ================================================================================================
# BUILD STAGE
# ================================================================================================
- stage: Build
  displayName: 'ğŸ—ï¸ Build CTS VibeApp'
  jobs:
  - job: Build
    displayName: 'Build and Package Application'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # Install Node.js
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'ğŸ”§ Install Node.js $(nodeVersion)'
    
    # Display build info
    - script: |
        echo "ğŸš€ Building CTS VibeApp Enhanced Version"
        echo "ğŸ“‹ Build Configuration: $(buildConfiguration)"
        echo "ğŸŒ Target Environment: $(environmentName)"
        echo "ğŸ“¦ Node.js Version: $(nodeVersion)"
        node --version
        npm --version
      displayName: 'ğŸ“‹ Build Information'
    
    # Install dependencies
    - script: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci --production=false
        echo "âœ… Dependencies installed successfully"
      displayName: 'ğŸ“¦ Install Dependencies'
    
    # Build application (if build script exists)
    - script: |
        echo "ğŸ—ï¸ Building application..."
        if npm run build --if-present; then
          echo "âœ… Build completed successfully"
        else
          echo "â„¹ï¸ No build script found, skipping build step"
        fi
      displayName: 'ğŸ—ï¸ Build Application'
    
    # Run tests (if test script exists)
    - script: |
        echo "ğŸ§ª Running tests..."
        if npm test --if-present; then
          echo "âœ… All tests passed"
        else
          echo "â„¹ï¸ No test script found, skipping tests"
        fi
      displayName: 'ğŸ§ª Run Tests'
      continueOnError: true
    
    # Security audit
    - script: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=moderate || echo "âš ï¸ Security audit completed with warnings"
      displayName: 'ğŸ”’ Security Audit'
      continueOnError: true
    
    # Prepare for deployment - install only production dependencies
    - script: |
        echo "ğŸ§¹ Cleaning up for deployment..."
        rm -rf node_modules
        npm ci --production
        echo "âœ… Production dependencies installed"
      displayName: 'ğŸ§¹ Prepare for Deployment'
    
    # Create deployment package
    - task: ArchiveFiles@2
      displayName: 'ğŸ“¦ Create Deployment Package'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/CTS-VibeApp-$(Build.BuildId).zip'
        replaceExistingArchive: true
        verbose: true
    
    # Publish build artifacts
    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ Publish Build Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/CTS-VibeApp-$(Build.BuildId).zip'
        ArtifactName: 'CTS-VibeApp-Package'
        publishLocation: 'Container'

# ================================================================================================
# DEPLOY STAGE
# ================================================================================================
- stage: Deploy
  displayName: 'ğŸš€ Deploy to Azure App Service'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployToProduction
    displayName: 'Deploy CTS VibeApp to Production'
    environment: '$(environmentName)'
    pool:
      vmImage: 'ubuntu-latest'
    
    variables:
      # Download build artifacts
      artifactName: 'CTS-VibeApp-Package'
    
    strategy:
      runOnce:
        deploy:
          steps:
          # Download artifacts
          - download: current
            artifact: $(artifactName)
            displayName: 'ğŸ“¥ Download Build Artifacts'
          
          # Display deployment info
          - script: |
              echo "ğŸš€ Starting deployment to Azure App Service"
              echo "ğŸŒ App Service: $(webAppName)"
              echo "ğŸ·ï¸ Build ID: $(Build.BuildId)"
              echo "ğŸ“¦ Package: CTS-VibeApp-$(Build.BuildId).zip"
              echo "ğŸ•’ Deployment Time: $(date)"
            displayName: 'ğŸ“‹ Deployment Information'
          
          # Deploy to Azure App Service
          - task: AzureWebApp@1
            displayName: 'ğŸŒ Deploy to Azure App Service'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webAppLinux'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/$(artifactName)/CTS-VibeApp-$(Build.BuildId).zip'
              runtimeStack: 'NODE|18-lts'
              startUpCommand: 'npm start'
              
              # App settings for production
              appSettings: |
                -NODE_ENV production
                -PORT 8080
                -WEBSITE_NODE_DEFAULT_VERSION 18.17.0
          
          # Health check
          - script: |
              echo "ğŸ” Performing health check..."
              sleep 30
              if curl -f "https://$(webAppName).azurewebsites.net/api/health"; then
                echo "âœ… Health check passed - Application is running"
              else
                echo "âš ï¸ Health check failed - Please verify deployment"
                exit 1
              fi
            displayName: 'ğŸ” Health Check'
            continueOnError: true
          
          # Post-deployment notification
          - script: |
              echo "=============================================="
              echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
              echo "=============================================="
              echo "ğŸŒ Application URL: https://$(webAppName).azurewebsites.net"
              echo "ğŸ”— Health Check: https://$(webAppName).azurewebsites.net/api/health"
              echo "ğŸ“Š Dashboard: https://$(webAppName).azurewebsites.net/dashboard"
              echo "ğŸ”´ Live Dashboard: https://$(webAppName).azurewebsites.net/live-dashboard"
              echo "ğŸ¤– AI Insights: https://$(webAppName).azurewebsites.net/ai-insights"
              echo "=============================================="
              echo "ğŸš€ CTS VibeApp Enhanced is now live!"
              echo "=============================================="
            displayName: 'ğŸ‰ Deployment Success Notification'
